---
title: 01. 성능 테스트 패턴 및 안티 패턴
author: mouseeye
date: 2022-11-01 00:00:00 +0900
categories: [Java, Optimization]
tags: [Java, Optimization]
---

## 1. 성능 테스트 유형
### 지연 테스트 (Latency test)
- 종단 트랜잭션에 걸리는 시간 측정
- 단순 평균값은 latency 측정에 큰 효과가 없음
  - 일반적으로 Latency는 정규분포곡선 형태를 띄지 않기 때문에, 구간별 평균 latency로 측정 (ex, p95 10ms / p99 20ms)

### 처리율 테스트 (Throughput test)
- 현재 시스템이 처리 가능한 동시 트랜잭션 갯수 (TPS, transaction per second)
- latency가 갑자기 변하는 변곡점이 `최대 처리율`로 볼 수 있음

### 부하 테스트 (Load test)
- 특정 목표치(부하)를 정해두고 시스템이 감당 할 수 있는지 테스트
  - 특정 이벤트에 대비하기 위해 부하 테스트 수행

### 스트레스 테스트 (Stress test)
- Q : 이 시스템의 한계점(breaking point)은 어디까지인가?
- 동시 처리 가능한 최대 처리율을 측정하여 시스템 여력 파악

### 내구성 테스트 (Endurance test)
- 시스템을 장시간 실행할 경우 성능 이상이 나타나는지 확인
  - 메모리 누수, 캐시 오염, 메모리 단편화 등이 발생
    - 캐시 오염 : 캐시에 복사본이 여러개 존재

### 용량 계획 테스트 (Capacity planning test)
- Q : 리소스를 추가한 만큼 시스템이 확장되는가?
- ***업그레이드된*** 시스템이 얼마나 부하를 감당할 수 있는지 측정
  - 스트레스 테스트와 같으나, 현재(스트레스 테스트) vs 업그레이드 (용량 계획 테스트)로 구분 하면 될듯

### 저하 테스트 (Degradation test)
- Q : 시스템 부분적으로 실패할 경우 어떤 일이 벌어지나?
- 넷플릭스에서 카오스 멍키 (Chaos Monkey)라는 실험을 수행 했고, 라이브 프로세스를 하나씩 램덤하게 죽이면서 ***시스템 탄력성 검증***

## 2. Basic Best Practice (성능 테스트시 고려 해야할)
### 하향식 성능 (Top-down performance)
- 전체 애플리케이션 성능 양상 부터 작은 코드 레벨로 순차적으로 성능 양상을 알아보는 방식 (전체 애플리케이션 -> 작은 코드 레벨)

### 테스트 환경 구축
- 테스트 환경은 가급적 운영 환경과 똑같이 구성

### 성능 요건 식별
- 시스템 전체적인 관점(not code level)에서 중요한 측정값을 식별하고 핵심 지표 산정
- ex) latency average를 30% 줄인다. / p95를 100ms으로 줄인다.

### 자바의 특정 이슈
- 자바 언어가 가지는 특성 (메모리 동적 관리, JIT 컴파일 등)으로 인해 발생하는 성능 저하 측정
- ex)
  - 애플리케이션 특성에 맞게끔 메모리 기법 튜닝
  - 중요한 메소드가 JIT 컴파일 타킷으로 지정되도록 유도

### 개발 생명 주기 레벨에서 성능 테스트 수행
- 말그대로 개발 생명 주기 레벨에서 성능 테스트를 수행 할 수 있도록 체계화

## 3. 성능 안티패턴
### 지루함
- 개발자 본인의 업무 지루함을 극복하기 위해, 필요 이상의 기술을 사용하는 케이스
  - 시스템 복잡도 증가

### 이력서 부풀리기
- 개발자 본인의 커리어를 위해 필요 이상의 기술을 사용하는 케이스
  - 시스템 복잡도 증가

### 이해 부족
- 최신 기술의 효용성을 검증없이 이해가 부족한 상태로 무턱대고 적용
  - 적용 후 사이드 이펙트 발생

### 오해와 있지도 않은 문제
- 분명한 문제 정의 없이 무턱대고 기술 적용
  - 문제 없이는 성능 개선 여부를 확인 할 수 없음

## 4. 성능 테스트시 주의해야할 인지 편향
### 환원주의
- 시스템 작은 부분을 이해하면 전체 시스템도 이해 할 수 있다는 분석주의적 사고방식
- 성능 테스트는 시스템을 전체로서 바라봐야 문제의 원인을 찾을 수 있다.

### 확증 편향
- 원래 가지고 있는 생각이나 신념을 확인하려는 경향
- 애플리케이션을 주관적으로 바라보게함

### 행동 편향
- 시스템이 예상대로 작동하지 않는 상황에,
- 문제를 해결하기 위해 뭐라도 해야한다는 생각에 검증 없이 적용
- 그로 인해, 더 큰 문제가 발생됨

### 위험 편향
- 위험을 피하고 변화를 거부하려는 인간의 특성으로 인해 최소한의 변경만 하는것
  - 단위 테스트와 운영계 회귀 테스트만 갖추면 리스크를 줄 일 수 있음

### 엘스버그 역설
- 확률이 존재하는 위험을 불확실성보다 더 선호한다.
- ex) thread pool 갯수가 부족하여 RejectedException이 발생했을때, thread pool이 부족한 이유를 개선하기 보다는, 가용 memory를 줄이는 thread pool size를 늘린다.

결론적으론,
성능 테스트시에는 문제를 수치화된 데이터 기반으로 명확하게 정의하고,
성능 결과를 평가 할때 수치화 가능한 방법으로 평가 (비과학적, 주관적인 사고 X)
