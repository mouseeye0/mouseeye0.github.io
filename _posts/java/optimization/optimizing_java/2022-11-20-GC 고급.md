---
title: 04. GC 고급
author: mouseeye
date: 2022-11-20 00:00:00 +0900
categories: [Java, Optimization]
tags: [Java, Optimization, GC]
---

### GC 선정 시 고려해야 할 사항
- 중단 시간
- 처리율
- 중단 빈도
- 회수 효율
- 중단 일관성
> 일반적으론 중단 시간이 중요하지만, 애플리케이션 특성마다 다르다.
> ex) 빅 데이터 시스템은 중단 시간보다 처리율이 더 중요

---
### GC 용어
#### 세이프포인트
- GC를 수행하기 위해서는 동작하고 있는 JVM 애플리케이션 쓰레드가 중단되어야 한다.
- 각 애플리케이션 쓰레드가 ***중단를 수행하는 지점***을 세이프포인트라고 한다.
- 애플리케이션 쓰레드가 **세이프포인트로 변경**은 다음과 같은 **순서**로 일어난다.
  1. JVM이 전역 `세이프포인트 시간` 플래그를 세팅
  2. 각 애플리케이션 쓰레드는 일정 주기로 폴링하면서 이 플래그가 세팅 됐는지 확인
     - 폴링 주기 : 메서드 밖으로 나가거나, 분기가 회귀하는 지점
     - 폴링하는 코드는 JIT 컴파일러가 컴파일 단계에서 삽입
  3. 플래그가 세팅 된게 확인 됐다면, 다시 깨어날 때까지 대기
- GC 이외에도 세이프포인트 상태가 되는 경우
  - 모니터에서 차단?
  - JNI 코드 실행

#### 삼색 마킹
- GC 대상 힙영역을 마킹하는 알고리즘
- 작동 원리
  1. GC 루트 회색 표시, 나머지 흰색 표시
  2. 마킹 쓰레드가 임의의 회색 노드로 이동,
     3. 자식 노드들을 회색으로 변경
     4. ii.의 임의의 회색 노드는 검은색으로 변경
  5. ii번 과정 반복
  6. 검은색으로 마킹된 부분은 살아남음, 흰색 노드는 접근 불가능한 객체로 GC 수행

---
### CMS
- 중단 시간을 아주 짧게 하려고 설계된 **올드 공간 전용 수집기**
- 영 세대 수집용 ParNew와 함께 사용
- 마킹은 삼색 마킹 알고리즘에 따라 수행
- `-XX:+UseConcMarkSweepGC`

#### CMS GC 수행 단계

1. 초기 마킹 (Initial Mark)
   - STW 발생
   - GC 루트의 위치 마킹
2. 동시 마킹 (Concurrent Mark)
   - 삼색 마킹 알고리즘을 이용해 마킹 진행
3. 동시 사전 정리 (Concurrent Pre clean)
4. 재마킹 (Remark)
   - **STW 발생**
   - 카드 테이블을 이용해 동시 마킹 단계 도중 상태가 변경된 영역을 조정
5. 동시 스위프 (Concurrent Sweep)
6. 동시 리셋 (Concurrent Reset)

#### CMS GC 특징
- 초기 마킹, 재마킹 단계에서만 애플리케이션 쓰레드가 멈춤
- 나머지 단계에서는 애플리케이션 쓰레드와 병행해서 GC 수행
  - 병행해서 GC를 할때 애플리케이션 동작에 영향이 없는건 아님,
  - 일반적으로 코어의 반을 GC 수행에 사용하기 때문에, 애플리케이션 동작에 전체를 수행 하던때와 성능 차이가 있음
- 애플리케이션 쓰레드가 오랫동안 멈추지 않는다.
- 단일 풀 GC 사이클 시간이 길다.
  - 많은 CPU 시간이 필요하다.
- 사이클이 실행되는 동안, 애플리케이션 처리율은 감소한다.
- GC가 객체를 추적해야 하므로 메모리를 더 많이 쓴다.
- 힙을 압착하지 않으므로 올드 영역은 단편화 될 수 있다.
- 할당률이 급증하면 **조기 승격**이 일어난다.
  - 조기 승격
    - 할당률이 급증하여 충분한 young GC 수집 사이클이 이루어지지 않은 단명 객체가 올드 영역으로 승격되는 현상
- 조기 승격으로.. 올드 영역의 공간이 부족해져 동시 모드 실패 CMF (Concurrent Mode Failure)이 발생
  - 이때, 애플리케이션 쓰레드는 사용할 메모리가 없어 동작 불가
  - 그로인해, 애플리케이션 쓰레드와 GC 쓰레드가 동시에 운용되지 못함
  - 그로인해, 풀 STW를 유발하는 ParallelOld GC 수집 방식으로 돌아감
  - CMF가 발생하지 않게 하려면 힙이 다 차기 전에, CMS 수집을 진행해야된다.
    - CMS 수집을 진행하는 디플트 메모리 사이즈는 **75% 테뉴어드**
    - 조정 가능
- CMF를 최소화 하기 위해, 프리 리스트를 이용해 사용 가능한 빈 공간을 관리함
  - 동시 스위프 단계에서 여유 공간을 연속된 빈 블록들을 하나로 뭉침


### G1
-


### ZGC
