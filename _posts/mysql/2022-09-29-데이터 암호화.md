---
title: 04. 데이터 암호화
author: mouseeye
date: 2022-09-29 00:30:00 +0900
categories: [MySQL]
tags: [MySQL, 데이터 암호화]
---

## MySQL 서버의 데이터 암호화

스토리지 엔진의 I/O 레이어에서만 암/복호화가 수행 된다. 그리하여, 데이터 암호화 기능이 활성화 되어 있음에도 MySQL 내부에서는 아무런 차이가 없기 때문에 TDE(Transparent Data Encryption) 방식이라고 불린다.

### 2단계 키 관리
- MySQL 서버는 2단계 키 관리 방식을 사용한다.
- 마스터 키와 테이블스페이스 키(프라이빗 키) 라는 2가지 종류의 키를 가지고 있다.
- 동작 방식은:
    - MySQL 서버는 키링 플러그인을 통해서 마스터 키를 생성하고 관리한다.
    - 암호화된 테이블이 생성될 때마다 해당 테이블을 위한 임의의 테이블스페이스 키를 발급한다.
    - 마스터 키를 이용해 테이블스페이스키를 암호화해 각 테이블의 데이터 파일 헤더에 저장한다.
- 마스터키는 외부의 파일을 이용하기 때문에 노출될 가능성이 있어, 주기적으로 변경이 필요하다.
- 테이블스페이스키는 외부로 노출되지 않기 때문에 주기적으로 변경하지 않아도 된다.
- 2단계 암호화 방식을 사용하는 이유는? 암호화 키 변경으로 인한 과도한 시스템 부하를 피하기 위해서 이다.
    - 테이블을 직접 암호화 하는 테이블스페이스키가 변경된다면, 변경시 모든 데이터를 암/복호화를 다시 해야하기 때문
- 키링 플러그인 종류:
    - keyring_file File-Based 플러그인 
    - keyring_encrypted_file Keyring 플러그인 
    - keyring_okv KMIP 플러그인 
    - keyring_aws Amazon Web Services Keyring 플러그인
- AES 256 알고리즘 지원

### 암호화와 성능
- 디스크에서 버퍼 풀로 데이터 페이지를 읽어올때 복호화 과정을 거치기 때문에 추가 연산이 필요하다.
- AES 알고리즘(블록 암호 방식)을 사용하기 때문에 데이터 파일의 크기는 암호화되지 않은것과 동일한 크기를 가진다.
- 압축과 암호화가 동시에 적용되면 압축을 먼저 실행하고 암호화를 적용한다.
    - 암호문은 랜덤한 문자열을 가지기 때문에 압축 효율이 좋지 않다.
    - 압축은 버퍼풀에 압축, 압축 해제 버전을 모두 가지고 있다.

### 암호화와 복제
- 소스 서버와 레플리카 서버는 서로 각자의 마스터 키와 테이블스페이스 키를 관리한다.
- 암호화 되기전의 값은 같지만 실제 암호화된 데이터가 저장된 데이터 파일의 내용은 완전히 다르다.

## 테이블 암호화
- `ENCRYPTION='Y'`를 사용해서 암호화 지원 테이블 생성할 수 있다.
```sql
CREATE TABLE tab_encrypted (
    id INT,
    data VARCHAR(100),
    PRIMARY KEY(id)
) ENCRYPTION='Y';
```
- 응용 프로그램에서 직접 암호화 하는 경우는 컬럼 암호화가 적용되어 인덱스 기능을 활용할 수 없다.
- 스토리지 엔진에서 지원하는 TDE는 인덱스 기능을 활용할 수 있다.

## 언두 로그 및 리두 로그 암호화
- `innodb_undo_log_encrypt` & `innodb_redo_log_encrypt` 시스템 변수를 통해서 암호화 기능 지원
- 언두/리두 로그을 위한 `프라이빗키`가 발급되고, 프라이빗키는 `마스터 키`로 암호화 되어 로그 파일 헤더에 저장된다.
- 암호화를 활성화/비활성화 할 수 있다.

## 바이너리 로그 암호화
- 로그 파일의 데이터는 `파일 키`로 암호화해서 디스크로 저장하고, 파일 키는 바이너리 로그 `암호화 키`로 암호화 되어 로그 파일 헤더에 저장된다.
- 암호화 키 변경 시 파일키도 변경되며 신규 생성된 키로 암호화를 수행한다.(기존 데이터 포함)
